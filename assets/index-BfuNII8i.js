(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const y=()=>"https://api-lofi.teplostanski.me",h=y();function l(s){const e=s.startsWith("/")?s.slice(1):s;return`${h}/${e}`}function g(){const s=h.startsWith("https")?"wss://":"ws://",e=new URL(h),t=e.port||(s==="wss://"?"443":"80");return`${s}${e.hostname}:${t}/ws`}async function v(){const e=await(await fetch(l("/info"))).json(),{name:t,version:n,time:i,FMInfo:r}=e.data,{cover:a,title:d,artist:u,sampleRate:c,bitRate:m,url:R}=r,f=l("/fm/info/cover"),p=l("/fm");return{serverInfo:{name:t,version:n,time:i},fmInfo:{cover:f,title:d,artist:u,sampleRate:c,bitRate:m,url:p}}}class E{constructor(e,t){this.onStateChange=e,this.onFmInfoUpdate=t,this.socket=null,this.destroyWebsocket=()=>{}}connect(){const e=r=>{console.log("WebSocket error:",r)},t=()=>{this.onStateChange({websocketStatus:"disconnected"}),this.destroyWebsocket(),setTimeout(()=>{this.connect()},5e3)},n=()=>{this.onStateChange({websocketStatus:"connected"})},i=r=>{const a=JSON.parse(r.data),d=l("/fm/info/cover"),u=l("/fm"),c={...a,cover:d,url:u};this.onFmInfoUpdate(c)};this.onStateChange({websocketStatus:"connecting"}),this.socket=new WebSocket(g()),this.socket.addEventListener("error",e),this.socket.addEventListener("close",t),this.socket.addEventListener("open",n),this.socket.addEventListener("message",i),this.destroyWebsocket=()=>{this.socket&&(this.socket.removeEventListener("error",e),this.socket.removeEventListener("close",t),this.socket.removeEventListener("open",n),this.socket.removeEventListener("message",i),this.socket.close())}}destroy(){this.destroyWebsocket()}}class S{constructor(e,t,n,i,r){this.audioElement=e,this.getState=t,this.setState=n,this.onError=i,this.onPlayPauseChange=r,this.setupEventListeners()}setupEventListeners(){this.audioElement.removeEventListener("error",this.handleAudioError),this.audioElement.removeEventListener("stalled",this.handleAudioStalled),this.audioElement.removeEventListener("waiting",this.handleAudioWaiting),this.audioElement.removeEventListener("canplay",this.handleAudioCanPlay),this.audioElement.removeEventListener("ended",this.handleAudioEnded),this.audioElement.removeEventListener("play",this.handlePlay),this.audioElement.removeEventListener("pause",this.handlePause),this.audioElement.addEventListener("error",this.handleAudioError.bind(this)),this.audioElement.addEventListener("stalled",this.handleAudioStalled.bind(this)),this.audioElement.addEventListener("waiting",this.handleAudioWaiting.bind(this)),this.audioElement.addEventListener("canplay",this.handleAudioCanPlay.bind(this)),this.audioElement.addEventListener("ended",this.handleAudioEnded.bind(this)),this.audioElement.addEventListener("play",this.handlePlay.bind(this)),this.audioElement.addEventListener("pause",this.handlePause.bind(this))}handlePlay(e){console.log("Событие play на audioElement:",e),this.onPlayPauseChange&&this.onPlayPauseChange(!1)}handlePause(e){console.log("Событие pause на audioElement:",e),this.onPlayPauseChange&&this.onPlayPauseChange(!0)}handleAudioError(e){console.error("Ошибка воспроизведения аудио:",e);const t=this.audioElement.error;let n="Ошибка воспроизведения";if(t)switch(t.code){case t.MEDIA_ERR_ABORTED:n="Воспроизведение прервано";break;case t.MEDIA_ERR_NETWORK:n="Ошибка сети";break;case t.MEDIA_ERR_DECODE:n="Ошибка декодирования";break;case t.MEDIA_ERR_SRC_NOT_SUPPORTED:n="Формат аудио не поддерживается";break;default:n="Неизвестная ошибка воспроизведения"}this.onError(new Error(n))}handleAudioStalled(e){console.warn("Воспроизведение аудио застряло:",e),setTimeout(()=>{const t=this.getState();t.playerStatus==="loading"&&!t.isRetrying&&this.onError(new Error("Таймаут воспроизведения"))},1e4)}handleAudioWaiting(e){console.log("Буферизация аудио:",e),this.getState().playerStatus==="playing"&&this.setState({playerStatus:"loading"})}handleAudioCanPlay(e){console.log("Аудио готово к воспроизведению:",e);const t=this.getState();t.playerStatus==="loading"&&!t.isMuted&&this.setState({playerStatus:"playing"})}handleAudioEnded(e){console.log("Воспроизведение аудио завершено:",e),this.getState().isMuted||this.onError(new Error("Поток аудио завершен"))}play(e,t){return this.setState({playerStatus:"loading"}),this.audioElement.src="",console.log("Попытка воспроизвести аудио:",e),this.audioElement.src=e,this.audioElement.volume=t?0:.8,this.audioElement.play().then(()=>{this.setState({playerStatus:"playing",retryCount:0,isRetrying:!1,hasPlayedOnce:!0})}).catch(n=>{console.error("Ошибка воспроизведения:",n),this.onError(n)})}pause(){this.audioElement.pause()}}function T(s){switch(s){case"connected":return"connected";case"connecting":return"connecting";case"disconnected":return"disconnected";default:return"connecting"}}function b(s){switch(s){case"connected":return"Подключено";case"connecting":return"Поключение";case"disconnected":return"Нет соединения";default:return"Поключение"}}function L(s,e){return s==="loading"?"loading-icon":e?"muted-btn":""}function w(s){return s.playerStatus==="loading"?s.isRetrying&&s.retryCount>0?`Повторная попытка (${s.retryCount})`:"Loading":s.playerStatus==="stopped"&&!s.hasPlayedOnce?"Запустить":s.isMuted?"Продолжить":"Заглушить"}class M{constructor(){this.playerCard=document.getElementById("playerCard")}render(e){if(e.errorMessage){this.renderError(e.errorMessage);return}if(!e.serverInfo||!e.fmInfo){this.renderLoading();return}this.renderPlayer(e)}renderError(e){this.playerCard.innerHTML=`
            <div class="error">
                ${e}
            </div>
        `}renderLoading(){this.playerCard.innerHTML=`
            <div class="loading">
                Loading...
            </div>
        `}renderPlayer(e){const{serverInfo:t,fmInfo:n,runningTime:i,playerStatus:r}=e;this.playerCard.innerHTML=`
            <div class="header">
                <div class="app-name">lo-fi cat</div>
                <div class="header-right">
                    <div class="running-time">${i}</div>
                    <div class="status-indicator">
                        <span class="connection-status ${T(e.websocketStatus)}"></span>
                        ${b(e.websocketStatus)}
                    </div>
                </div>
            </div>

            <div class="music-info">
                <img src="${n.cover}" alt="Album Cover" class="album-cover">
                <div class="track-info">
                    <div class="track-title">${n.title}</div>
                    <div class="track-artist">${n.artist}</div>
                </div>
                <div class="controls">
                    <button class="mute-btn ${L(r,e.isMuted)}" data-action="toggle-mute" title="${e.playerStatus==="stopped"&&!e.hasPlayedOnce?"Нажмите чтобы начать воспроизведение":e.isMuted?"Нажмите чтобы включить звук":"Нажмите чтобы выключить звук"}">
                        ${w(e)}
                    </button>
                </div>
            </div>
        `}updateRunningTime(e){const t=document.querySelector(".running-time");t&&(t.textContent=e)}updateBackground(e){const t=document.getElementById("backgroundBlur");t&&(t.style.backgroundImage=`url(${e})`)}}function I(s,e){document.title=s;let t=document.querySelector('meta[name="apple-mobile-web-app-title"]');t&&t.setAttribute("content",s);let n=document.querySelector('meta[name="application-name"]');n&&n.setAttribute("content",s),P(e)}function P(s){let e=document.getElementById("favicon");e&&(e.href=s),["appleTouchIcon1","appleTouchIcon2","appleTouchIcon3","appleTouchIcon4"].forEach(i=>{const r=document.getElementById(i);r&&(r.href=s)});let n=document.getElementById("tileImage");n&&n.setAttribute("content",s)}function k(s){let e=Math.floor(s/1e3),t=Math.floor(e/3600);e-=t*3600;let n=Math.floor(e/60),i=e-n*60;return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(i).padStart(2,"0")}`}class C{constructor(){this.state={errorMessage:"",runningTime:"00:00:00",timer:null,serverInfo:null,fmInfo:null,playerStatus:"stopped",websocketStatus:"connecting",isMuted:!0,retryCount:0,retryTimer:null,isRetrying:!1,hasPlayedOnce:!1},this.audioElement=document.getElementById("audioPlayer"),this.renderer=new M,this.websocket=null,this.audioPlayer=null,this.eventListenersSetup=!1,this.init()}async init(){this.setupEventListeners(),this.renderer.render(this.state),this.setTimerToUpdateRunningTime(),this.audioPlayer=new S(this.audioElement,()=>this.state,e=>this.setState(e),e=>this.handlePlayError(e),e=>this.syncMuteState(e)),this.websocket=new E(e=>this.setState(e),e=>{this.setState({fmInfo:e}),this.renderer.updateBackground(e.cover)});try{await this.initInfo(),this.websocket.connect()}catch(e){this.setState({errorMessage:e.message||e.toString()})}}setState(e){this.state={...this.state,...e},this.renderer.render(this.state)}async initInfo(){const{serverInfo:e,fmInfo:t}=await v();this.setState({serverInfo:e,fmInfo:t}),I(e.name,t.cover),this.renderer.updateBackground(t.cover)}toggleMute(){this.state.playerStatus==="stopped"?this.unmute():this.state.isMuted?this.unmute():this.mute()}syncMuteState(e){this.state.isMuted!==e&&(e?(this.state.retryTimer&&clearTimeout(this.state.retryTimer),this.setState({isMuted:!0,playerStatus:"stopped",retryCount:0,retryTimer:null,isRetrying:!1})):this.setState({isMuted:!1,playerStatus:this.audioElement.paused?"stopped":"playing"}))}mute(){this.state.retryTimer&&clearTimeout(this.state.retryTimer),this.audioPlayer.pause(),this.setState({isMuted:!0,playerStatus:"stopped",retryCount:0,retryTimer:null,isRetrying:!1})}unmute(){this.state.fmInfo&&(this.setState({isMuted:!1,errorMessage:"",retryCount:0,isRetrying:!1}),this.play())}setPlayerStatus(){this.toggleMute()}play(){this.state.fmInfo&&this.audioPlayer.play(this.state.fmInfo.url,this.state.isMuted)}handlePlayError(e){if(console.error("Обработка ошибки воспроизведения:",e.message),this.state.isMuted)return;const t=this.state.retryCount+1;let n;t<=3?n=1e3:t<=10?n=5e3:n=3e4,this.setState({playerStatus:"loading",retryCount:t,isRetrying:!0}),console.log(`Воспроизведение не удалось, повторная попытка ${t} через ${n/1e3} секунд...`),this.state.retryTimer&&clearTimeout(this.state.retryTimer);const i=setTimeout(()=>{!this.state.isMuted&&this.state.fmInfo?(console.log(`Выполняем повторную попытку ${t}`),this.play()):this.setState({isRetrying:!1})},n);this.setState({retryTimer:i})}stop(){this.state.retryTimer&&clearTimeout(this.state.retryTimer),this.audioPlayer.pause(),this.setState({playerStatus:"stopped",isMuted:!0,retryCount:0,retryTimer:null,isRetrying:!1})}setTimerToUpdateRunningTime(){const e=setTimeout(()=>{if(this.state.serverInfo){const t=k(Date.now()-this.state.serverInfo.time);this.renderer.updateRunningTime(t),this.state.runningTime=t}this.setTimerToUpdateRunningTime()},1e3);this.state.timer=e}setupEventListeners(){if(this.eventListenersSetup)return;const e=document.getElementById("playerCard");e&&(e.addEventListener("click",t=>{t.target.closest('[data-action="toggle-mute"]')&&(t.preventDefault(),this.toggleMute())}),this.eventListenersSetup=!0)}}let o;document.addEventListener("DOMContentLoaded",()=>{o=new C});window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),console.log("PWA можно установить")});window.addEventListener("appinstalled",s=>{console.log("PWA установлено")});window.addEventListener("DOMContentLoaded",()=>{let s="browser";navigator.standalone&&(s="standalone-ios"),window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches&&(s="standalone"),document.body.classList.add(`display-${s}`)});window.addEventListener("beforeunload",()=>{o&&o.state.timer&&clearTimeout(o.state.timer),o&&o.state.retryTimer&&clearTimeout(o.state.retryTimer),o&&o.websocket&&o.websocket.destroy()});
