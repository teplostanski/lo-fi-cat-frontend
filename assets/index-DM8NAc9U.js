(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const v=()=>{const r=window.location.hostname,t=window.location.protocol;return r==="api-lofi.teplostanski.me"||r.includes("teplostanski.me")?`${t}//api-lofi.teplostanski.me`:"http://localhost:8090"},m=v();function l(r){const t=r.startsWith("/")?r.slice(1):r;return`${m}/${t}`}function S(){const r=m.startsWith("https")?"wss://":"ws://",t=new URL(m),e=t.port||(r==="wss://"?"443":"80");return`${r}${t.hostname}:${e}/ws`}class E{constructor(){this.state={errorMessage:"",runningTime:"00:00:00",timer:null,serverInfo:null,fmInfo:null,playerStatus:"stopped",websocketStatus:"connecting",isMuted:!0,retryCount:0,retryTimer:null,isRetrying:!1,hasPlayedOnce:!1},this.audioPlayer=document.getElementById("audioPlayer"),this.socket=null,this.destroyWebsocket=()=>{},this.eventListenersSetup=!1,this.init()}async init(){this.setupEventListeners(),this.render(),this.setTimerToUpdateRunningTime();try{await this.initInfo(),this.initWebsocket()}catch(t){this.setState({errorMessage:t.message||t.toString()})}}setState(t){this.state={...this.state,...t},this.render()}async initInfo(){const e=await(await fetch(l("/info"))).json(),{name:s,version:i,time:n,FMInfo:a}=e.data,{cover:d,title:c,artist:u,sampleRate:f,bitRate:y,url:b}=a,h=l("/fm/info/cover"),p=l("/fm");this.setState({serverInfo:{name:s,version:i,time:n},fmInfo:{cover:h,title:c,artist:u,sampleRate:f,bitRate:y,url:p}}),this.updatePWAInfo(s,h);const g=document.getElementById("backgroundBlur");g.style.backgroundImage=`url(${h})`}updatePWAInfo(t,e){document.title=t;let s=document.querySelector('meta[name="apple-mobile-web-app-title"]');s&&s.setAttribute("content",t);let i=document.querySelector('meta[name="application-name"]');i&&i.setAttribute("content",t),this.updateIcons(e)}updateIcons(t){let e=document.getElementById("favicon");e&&(e.href=t),["appleTouchIcon1","appleTouchIcon2","appleTouchIcon3","appleTouchIcon4"].forEach(n=>{const a=document.getElementById(n);a&&(a.href=t)});let i=document.getElementById("tileImage");i&&i.setAttribute("content",t)}initWebsocket(){const t=n=>{console.log("WebSocket error:",n)},e=()=>{this.setState({websocketStatus:"disconnected"}),this.destroyWebsocket(),setTimeout(()=>{this.initWebsocket()},5e3)},s=()=>{this.setState({websocketStatus:"connected"})},i=n=>{const a=JSON.parse(n.data),d=l("/fm/info/cover"),c=l("/fm");this.setState({fmInfo:{...a,cover:d,url:c}});const u=document.getElementById("backgroundBlur");u.style.backgroundImage=`url(${d})`};this.setState({websocketStatus:"connecting"}),this.socket=new WebSocket(S()),this.socket.addEventListener("error",t),this.socket.addEventListener("close",e),this.socket.addEventListener("open",s),this.socket.addEventListener("message",i),this.destroyWebsocket=()=>{this.socket&&(this.socket.removeEventListener("error",t),this.socket.removeEventListener("close",e),this.socket.removeEventListener("open",s),this.socket.removeEventListener("message",i),this.socket.close())}}toggleMute(){this.state.playerStatus==="stopped"?this.unmute():this.state.isMuted?this.unmute():this.mute()}mute(){this.state.retryTimer&&clearTimeout(this.state.retryTimer),this.audioPlayer.pause(),this.setState({isMuted:!0,playerStatus:"stopped",retryCount:0,retryTimer:null,isRetrying:!1})}unmute(){this.state.fmInfo&&(this.setState({isMuted:!1,errorMessage:"",retryCount:0,isRetrying:!1}),this.play())}setPlayerStatus(){this.toggleMute()}play(){if(!this.state.fmInfo)return;this.setState({playerStatus:"loading"}),this.audioPlayer.src="";const t=this.state.fmInfo.url;console.log("Попытка воспроизвести аудио:",t),this.audioPlayer.src=t,this.audioPlayer.volume=this.state.isMuted?0:.8,this.setupAudioEventListeners(),this.audioPlayer.play().then(()=>{this.setState({playerStatus:"playing",retryCount:0,isRetrying:!1,hasPlayedOnce:!0})}).catch(e=>{console.error("Ошибка воспроизведения:",e),this.handlePlayError(e)})}setupAudioEventListeners(){this.audioPlayer.removeEventListener("error",this.handleAudioError),this.audioPlayer.removeEventListener("stalled",this.handleAudioStalled),this.audioPlayer.removeEventListener("waiting",this.handleAudioWaiting),this.audioPlayer.removeEventListener("canplay",this.handleAudioCanPlay),this.audioPlayer.removeEventListener("ended",this.handleAudioEnded),this.audioPlayer.addEventListener("error",this.handleAudioError.bind(this)),this.audioPlayer.addEventListener("stalled",this.handleAudioStalled.bind(this)),this.audioPlayer.addEventListener("waiting",this.handleAudioWaiting.bind(this)),this.audioPlayer.addEventListener("canplay",this.handleAudioCanPlay.bind(this)),this.audioPlayer.addEventListener("ended",this.handleAudioEnded.bind(this))}handleAudioError(t){console.error("Ошибка воспроизведения аудио:",t);const e=this.audioPlayer.error;let s="Ошибка воспроизведения";if(e)switch(e.code){case e.MEDIA_ERR_ABORTED:s="Воспроизведение прервано";break;case e.MEDIA_ERR_NETWORK:s="Ошибка сети";break;case e.MEDIA_ERR_DECODE:s="Ошибка декодирования";break;case e.MEDIA_ERR_SRC_NOT_SUPPORTED:s="Формат аудио не поддерживается";break;default:s="Неизвестная ошибка воспроизведения"}this.handlePlayError(new Error(s))}handleAudioStalled(t){console.warn("Воспроизведение аудио застряло:",t),setTimeout(()=>{this.state.playerStatus==="loading"&&!this.state.isRetrying&&this.handlePlayError(new Error("Таймаут воспроизведения"))},1e4)}handleAudioWaiting(t){console.log("Буферизация аудио:",t),this.state.playerStatus==="playing"&&this.setState({playerStatus:"loading"})}handleAudioCanPlay(t){console.log("Аудио готово к воспроизведению:",t),this.state.playerStatus==="loading"&&!this.state.isMuted&&this.setState({playerStatus:"playing"})}handleAudioEnded(t){console.log("Воспроизведение аудио завершено:",t),this.state.isMuted||this.handlePlayError(new Error("Поток аудио завершен"))}handlePlayError(t){if(console.error("Обработка ошибки воспроизведения:",t.message),this.state.isMuted)return;const e=this.state.retryCount+1;let s;e<=3?s=1e3:e<=10?s=5e3:s=3e4,this.setState({playerStatus:"loading",retryCount:e,isRetrying:!0}),console.log(`Воспроизведение не удалось, повторная попытка ${e} через ${s/1e3} секунд...`),this.state.retryTimer&&clearTimeout(this.state.retryTimer);const i=setTimeout(()=>{!this.state.isMuted&&this.state.fmInfo?(console.log(`Выполняем повторную попытку ${e}`),this.play()):this.setState({isRetrying:!1})},s);this.setState({retryTimer:i})}stop(){this.state.retryTimer&&clearTimeout(this.state.retryTimer),this.audioPlayer.pause(),this.setState({playerStatus:"stopped",isMuted:!0,retryCount:0,retryTimer:null,isRetrying:!1})}setTimerToUpdateRunningTime(){const t=setTimeout(()=>{if(this.state.serverInfo){const e=this.formatTime(Date.now()-this.state.serverInfo.time),s=document.querySelector(".running-time");s&&(s.textContent=e),this.state.runningTime=e}this.setTimerToUpdateRunningTime()},1e3);this.state.timer=t}formatTime(t){let e=Math.floor(t/1e3),s=Math.floor(e/3600);e-=s*3600;let i=Math.floor(e/60),n=e-i*60;return`${String(s).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(n).padStart(2,"0")}`}getStatusClass(){switch(this.state.websocketStatus){case"connected":return"connected";case"connecting":return"connecting";case"disconnected":return"disconnected";default:return"connecting"}}getStatusText(){switch(this.state.websocketStatus){case"connected":return"Подключено";case"connecting":return"Поключение";case"disconnected":return"Нет соединения";default:return"Поключение"}}getMuteButtonClass(){return this.state.playerStatus==="loading"?"loading-icon":this.state.isMuted?"muted-btn":""}getMuteButtonText(){return this.state.playerStatus==="loading"?this.state.isRetrying&&this.state.retryCount>0?`Повторная попытка (${this.state.retryCount})`:"Loading":this.state.playerStatus==="stopped"&&!this.state.hasPlayedOnce?"Запустить":this.state.isMuted?"Продолжить":"Заглушить"}render(){const t=document.getElementById("playerCard");if(this.state.errorMessage){t.innerHTML=`
                <div class="error">
                    ${this.state.errorMessage}
                </div>
            `;return}if(!this.state.serverInfo||!this.state.fmInfo){t.innerHTML=`
                <div class="loading">
                    Loading...
                </div>
            `;return}const{serverInfo:e,fmInfo:s,runningTime:i,playerStatus:n}=this.state;t.innerHTML=`
            <div class="header">
                <div class="app-name">lo-fi cat</div>
                <div class="header-right">
                    <div class="running-time">${i}</div>
                    <div class="status-indicator">
                        <span class="connection-status ${this.getStatusClass()}"></span>
                        ${this.getStatusText()}
                    </div>
                </div>
            </div>

            <div class="music-info">
                <img src="${s.cover}" alt="Album Cover" class="album-cover">
                <div class="track-info">
                    <div class="track-title">${s.title}</div>
                    <div class="track-artist">${s.artist}</div>
                </div>
                <div class="controls">
                    <button class="mute-btn ${this.getMuteButtonClass()}" data-action="toggle-mute" title="${this.state.playerStatus==="stopped"&&!this.state.hasPlayedOnce?"Нажмите чтобы начать воспроизведение":this.state.isMuted?"Нажмите чтобы включить звук":"Нажмите чтобы выключить звук"}">
                        ${this.getMuteButtonText()}
                    </button>
                </div>
            </div>
        `}setupEventListeners(){if(this.eventListenersSetup)return;const t=document.getElementById("playerCard");t&&(t.addEventListener("click",e=>{e.target.closest('[data-action="toggle-mute"]')&&(e.preventDefault(),this.toggleMute())}),this.eventListenersSetup=!0)}}let o;document.addEventListener("DOMContentLoaded",()=>{o=new E});window.addEventListener("beforeinstallprompt",r=>{r.preventDefault(),console.log("PWA можно установить")});window.addEventListener("appinstalled",r=>{console.log("PWA установлено")});window.addEventListener("DOMContentLoaded",()=>{let r="browser";navigator.standalone&&(r="standalone-ios"),window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches&&(r="standalone"),document.body.classList.add(`display-${r}`)});window.addEventListener("beforeunload",()=>{o&&o.state.timer&&clearTimeout(o.state.timer),o&&o.state.retryTimer&&clearTimeout(o.state.retryTimer),o&&o.destroyWebsocket&&o.destroyWebsocket()});
